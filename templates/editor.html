<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }}</title>
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #editorContainer {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 70%;
        }

        textarea {
            width: 100%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
            resize: none;
        }
    </style>
</head>

<body>
    <div id="editorContainer">
        <textarea id="textEditor">{{ .Content }}</textarea>
    </div>
    <script>
        function getUUIDFromURL() {
            const pathname = window.location.pathname;
            const segments = pathname.split('/');
            return segments[2];
        }

        const uuid = getUUIDFromURL();

        editor = document.getElementById('textEditor');
        const connectionButton = document.getElementById('toggleConnection');
        let socket;
        let isConnected = false;

        function connectWebSocket() {
            socket = new WebSocket('ws://localhost:8080/documents/' + uuid + '/ws'); // Modify this URL to your WebSocket server
            socket.onopen = function (event) {
                console.log('WebSocket is connected.');
                retryInterval = 1000;
            };

            socket.onmessage = function (event) {
                const ev = JSON.parse(event.data)
                console.log(ev)
                document.title = ev.Data.Title
                editor.value = applyBufferTo(ev.Data.Content)
                console.log('Message from server ', event.data);
            };

            socket.onclose = function (event) {
                console.log('WebSocket closed. Attempting to reconnect...', event.reason);
                setTimeout(() => {
                    connectWebSocket();
                }, retryInterval);
                retryInterval = Math.min(2 * retryInterval, 30000);
            };

            socket.onerror = function (event) {
                console.error('WebSocket error observed:', event);
            };
        }

        connectWebSocket()

        const buffer = {
            operation: '',
            position: 0,
            string: '',
            delete: 0,
            timeoutId: null
        };

        function applyBufferTo(text) {
            if (buffer.operation == '') return text
            if (buffer.delete > 0) {
                return removeFromString(text, buffer.delete, buffer.position)
            }
            return insertString(text, buffer.string, buffer.position)

        }

        function sendBuffer() {
            if (!buffer.operation) return; // Exit if there is no operation to send

            const payload = JSON.stringify({
                command: buffer.operation === 'insertText' ? 'insert_event' : 'delete_event',
                uuid: uuid,
                data: {
                    position: buffer.position,
                    string: buffer.string,
                    delete: buffer.delete
                }
            });

            socket.send(payload);

            // Reset buffer after sending
            resetBuffer();
        }

        function resetBuffer() {
            buffer.operation = '';
            buffer.position = 0;
            buffer.string = '';
            buffer.delete = 0;
            if (buffer.timeoutId) {
                clearTimeout(buffer.timeoutId);
            }
            buffer.timeoutId = null;
        }


        editor.addEventListener('input', function (event) {
            const { inputType, data } = event;
            const currentPosition = editor.selectionStart;

            // Clear the previous timeout to reset the delay
            if (buffer.timeoutId) {
                clearTimeout(buffer.timeoutId);
            }
            buffer.timeoutId = null;

            // Determine the new operation type and if it should be grouped
            if (inputType === 'insertText' || inputType === 'insertFromPaste') {
                handleInsertOperation(data, currentPosition);
            } else if (inputType === 'deleteContentBackward') {
                handleDeleteOperation(currentPosition);
            } else {
                // Any other operations, just send the buffer
                sendBuffer();
            }

            // Set a timeout to send the buffer if no other inputs are received within 400ms
            buffer.timeoutId = setTimeout(sendBuffer, 300);
        });

        editor.addEventListener('keydown', function (event) {
            const currentPosition = editor.selectionStart;
            if (event.key === 'Enter') {
                console.log(currentPosition)
                handleInsertOperation("\n", currentPosition + 1)
                console.log(buffer)
            }
        });

        function handleInsertOperation(data, currentPosition) {
            if (buffer.operation === 'insertText' && buffer.position + buffer.string.length === currentPosition - 1) {
                // Group this insert with the previous one
                buffer.string += data;
            } else {
                // Send previous buffer if it was different operation
                sendBuffer();
                buffer.operation = 'insertText';
                buffer.position = currentPosition - 1;
                buffer.string = data;
                buffer.delete = 0;
            }
        }

        function handleDeleteOperation(currentPosition) {
            if (buffer.operation === 'deleteContentBackward' && buffer.position === currentPosition) {
                // Group this delete with the previous one
                buffer.delete++;
            } else {
                // Send previous buffer if it was different operation
                sendBuffer();
                buffer.operation = 'deleteContentBackward';
                buffer.position = currentPosition;
                buffer.string = '';
                buffer.delete = 1;
            }
            console.log(buffer)
        }


        function insertString(original, insert, index) {
            if (insert == undefined) return original
            return original.substring(0, index) + insert + original.substring(index);
        }

        function removeFromString(original, count, index) {
            const to = Math.max(index - count + 1, 0);
            return original.substring(0, to) + original.substring(index + 1);
        }

    </script>
</body>

</html>